<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
</head>

<body>
{% include "navbar.html" %}
<div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert alert-{{ messages[0][0] }} mt-3">
                {{ messages[0][1] }}
            </div>
        {% endif %}
    {% endwith %}
</div>
<div class="container-fluid" style="padding-right: 20%; padding-left: 20%; padding-top: 20px">
    <form id="registerForm" class="border rounded p-3" method="POST" action="{{ url_for('auth.register') }}" enctype="multipart/form-data">
        <h4 style="text-align: center;">Register to have more features</h4>
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" name="username" class="form-control" placeholder="Enter your username" required>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password" required>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" name="email" class="form-control" placeholder="Enter your email" required>
        </div>
        <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <input type="text" id="address" name="address" class="form-control" placeholder="Enter your address">
            <button type="button" id="findAddress" class="btn btn-secondary mt-2">Find Address</button>
        </div>
        <div class="mb-3">
            <label for="zipcode" class="form-label">Zip Code</label>
            <input type="text" id="zipcode" name="zipcode" class="form-control" placeholder="Enter your zip code">
        </div>
        <div id="map" style="height: 300px; border: 1px solid #ccc;"></div>
        <div class="mb-3">
            <label for="coordinates" class="form-label">Coordinates</label>
            <input type="text" id="coordinates" name="coordinates" class="form-control" readonly>
        </div>
        <button type="submit" class="btn btn-dark d-block mx-auto">Register</button>
        <div style="text-align: center;">
            <a href="{{ url_for('auth.login') }}">Already have an account? Log in here</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
    const map = L.map('map').setView([48.2082, 16.3738], 10);
    const austriaBounds = [[46.3723, 9.5308], [49.0206, 17.1605]];

    map.fitBounds(austriaBounds);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    map.setMaxBounds(austriaBounds);
    map.on('drag', function () {
        map.panInsideBounds(austriaBounds, { animate: true });
    });

    let marker;

    function isWithinAustria(lat, lng) {
        return (
            lat >= austriaBounds[0][0] &&
            lat <= austriaBounds[1][0] &&
            lng >= austriaBounds[0][1] &&
            lng <= austriaBounds[1][1]
        );
    }

    map.on('click', function (e) {
        const { lat, lng } = e.latlng;

        if (!isWithinAustria(lat, lng)) {
            alert('The selected location is outside Austria. Please select a location within Austria.');
            return;
        }

        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }

        document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    });

    document.getElementById('findAddress').addEventListener('click', function () {
        const address = document.getElementById('address').value.trim();
        const zipCode = document.getElementById('zipcode').value.trim();

        if (!address) {
            alert('Please enter an address.');
            return;
        }

        const query = zipCode ? `${address}, ${zipCode}, Austria` : `${address}, Austria`;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    alert('Address not found. Please enter a valid address within Austria.');
                    return;
                }

                const { lat, lon } = data[0];

                if (!isWithinAustria(parseFloat(lat), parseFloat(lon))) {
                    alert('The searched address is outside Austria.');
                    return;
                }

                map.setView([lat, lon], 15);
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon]).addTo(map);
                }

                document.getElementById('coordinates').value = `${parseFloat(lat).toFixed(6)}, ${parseFloat(lon).toFixed(6)}`;
            })
            .catch(() => {
                alert('Error fetching address location. Please try again later.');
            });
    });
</script>
</body>
</html>
